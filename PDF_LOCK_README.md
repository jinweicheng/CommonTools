# PDF 加密/解密功能说明

## 🔐 功能概述

本工具实现了**本地 PDF 加密和解密**功能，完全在浏览器中处理，不上传到任何服务器。

### ✨ 两种加密模式

#### 📄 标准加密模式（推荐日常使用）
- ✅ 任何 PDF 阅读器都可以直接打开
- ✅ 密码信息存储在 PDF 元数据中
- ✅ 适合日常文档分享和存档
- ⚠️ 安全性：中等（元数据可被技术手段读取）

#### 🔒 强加密模式（推荐敏感文档）
- ✅ AES-256-GCM 军事级加密
- ✅ 完全加密 PDF 内容，无法直接查看
- ✅ 需要本工具解密才能打开
- ✅ 安全性：极高（真正的内容加密）
- ⚠️ 忘记密码将无法恢复

### ✨ 主要特点

1. **两种加密模式**：标准加密（兼容性好）+ 强加密（安全性高）
2. **本地处理**：所有操作在浏览器本地完成，保护隐私
3. **密码保护**：支持打开密码（User Password）和权限密码（Owner Password）
4. **权限控制**：可设置打印、复制、修改、注释等权限
5. **完整性保护**：强加密模式使用 PBKDF2（100,000 次迭代）增强密码安全性

---

## 🔒 加密 PDF（Lock PDF）

### 功能说明

将普通 PDF 文件加密，生成受保护的 PDF 文件。支持两种加密模式。

### 使用步骤

1. **选择加密模式**
   - **标准加密**：任何 PDF 阅读器可打开（推荐日常使用）
   - **强加密**：需要本工具解密（推荐敏感文档）

2. **设置打开密码**（必填）
   - 用户需要输入此密码才能打开和查看 PDF
   - 请务必记住密码，忘记密码将无法恢复

3. **设置权限密码**（可选）
   - 用于控制文档的编辑、打印等权限
   - 当前版本权限存储在元数据中

4. **配置权限设置**
   - ✅ 允许打印
   - ✅ 允许复制内容
   - ✅ 允许修改文档
   - ✅ 允许添加注释

5. **上传 PDF 文件**
   - 点击"选择 PDF 文件并加密"按钮
   - 选择要加密的 PDF 文件
   - 等待加密完成

6. **下载加密后的 PDF**
   - 标准加密：自动下载 `xxx-protected.pdf`
   - 强加密：自动下载 `xxx-locked.pdf`

### 加密原理

#### 标准加密模式

```
原始 PDF → 生成密码哈希 → 存储到元数据 → 添加保护标记 → 受保护的 PDF
```

- 密码使用 SHA-256 哈希后存储在 PDF 元数据中
- 权限信息以 Base64 编码存储
- PDF 内容本身不加密，任何阅读器都可以打开
- 适合需要兼容性的场景

#### 强加密模式

```
原始 PDF → AES-256-GCM 加密 → 生成保护页面 → 嵌入加密数据 → 受保护的 PDF
```

- PDF 内容完全加密，无法直接查看
- 需要本工具解密才能恢复原始内容
- 适合高安全性要求的场景

#### 技术细节

1. **密钥派生**
   - 使用 PBKDF2 算法从密码派生 256 位密钥
   - 迭代次数：100,000 次
   - 哈希算法：SHA-256
   - 随机盐值：16 字节

2. **内容加密**
   - 算法：AES-256-GCM
   - IV（初始化向量）：12 字节随机生成
   - 加密整个 PDF 文件内容

3. **数据存储**
   - 加密信息存储在 PDF 元数据中（JSON 格式）
   - 加密数据附加在 PDF 文件末尾
   - 使用特殊标记分隔：`%%ENCRYPTED_DATA_START%%`

4. **保护页面**
   - 生成一个信息页面，显示加密状态
   - 包含文档信息和权限设置
   - 提示用户使用本工具解密

### 文件结构

```
[受保护的 PDF 文件]
├── PDF 信息页面（显示加密状态）
├── PDF 元数据（加密信息）
├── %%ENCRYPTED_DATA_START%% 标记
├── 加密的原始 PDF 内容
└── %%ENCRYPTED_DATA_INFO%% 元数据
```

---

## 🔓 解密 PDF（Unlock PDF）

### 功能说明

解密已加密的 PDF 文件，恢复原始内容。

### 使用步骤

1. **输入密码**
   - 输入加密时设置的打开密码（User Password）

2. **上传加密的 PDF**
   - 点击"选择加密的 PDF 文件并解密"按钮
   - 选择 `xxx-locked.pdf` 文件

3. **验证密码**
   - 系统会自动验证密码
   - 密码错误会提示重新输入

4. **下载解密后的 PDF**
   - 解密成功后，自动下载原始 PDF
   - 文件名会自动添加 `-unlocked` 后缀

### 解密原理

```
受保护的 PDF → 提取加密信息 → 验证密码 → AES-256-GCM 解密 → 原始 PDF
```

#### 技术细节

1. **数据提取**
   - 读取 PDF 文件，查找 `%%ENCRYPTED_DATA_INFO%%` 标记
   - 解析加密信息（算法、盐值、IV、数据位置等）
   - 提取加密的 PDF 内容

2. **密钥派生**
   - 使用相同的 PBKDF2 参数和盐值
   - 从用户输入的密码派生密钥

3. **内容解密**
   - 使用 AES-256-GCM 解密
   - 验证密码正确性（GCM 模式自带认证）
   - 密码错误会抛出异常

4. **PDF 恢复**
   - 加载解密后的数据为 PDF 文档
   - 保存为标准 PDF 文件

---

## ⚠️ 重要提示

### 安全性

✅ **优点**
- 使用军事级 AES-256-GCM 加密
- PBKDF2 密钥派生（100,000 次迭代）
- 完全本地处理，不上传到服务器
- 密码和文件永远不会离开您的设备

⚠️ **限制**
- 加密后的 PDF 需要使用本工具解密
- 标准 PDF 阅读器无法直接打开加密的 PDF
- 权限设置存储在元数据中，仅作为标记

### 密码管理

❗ **请务必记住密码**
- 忘记密码将无法恢复文件
- 没有"找回密码"功能
- 建议使用密码管理器保存密码

### 兼容性

✅ **支持的浏览器**
- Chrome 60+
- Firefox 57+
- Safari 11+
- Edge 79+

❌ **不支持**
- IE 浏览器
- 旧版本浏览器（不支持 Web Crypto API）

---

## 🆚 与 PDF24 的对比

| 功能 | PDF24 | 本工具（标准模式） | 本工具（强加密模式） |
|------|-------|------------------|-------------------|
| 加密算法 | AES-256（标准 PDF） | SHA-256 哈希 | AES-256-GCM |
| 处理位置 | 服务器端 | 浏览器本地 ✅ | 浏览器本地 ✅ |
| 隐私保护 | 需上传文件 | 完全本地 ✅ | 完全本地 ✅ |
| 兼容性 | 所有 PDF 阅读器 | 所有 PDF 阅读器 ✅ | 需本工具解密 |
| 打开密码 | ✅ 支持 | ✅ 支持 | ✅ 支持 |
| 权限密码 | ✅ 支持 | ⚠️ 元数据标记 | ⚠️ 元数据标记 |
| 权限控制 | ✅ 强制执行 | ⚠️ 标记（不强制） | ⚠️ 标记（不强制） |
| 内容加密 | ✅ 真正加密 | ❌ 不加密 | ✅ 真正加密 |
| 密码恢复 | ❌ 不支持 | ❌ 不支持 | ❌ 不支持 |

### 为什么不使用标准 PDF 加密？

**浏览器限制**：
- `pdf-lib` 库不支持标准 PDF 加密（`encrypt` 方法）
- 浏览器环境无法实现 PDF 规范的加密字典
- 标准 PDF 加密需要底层 PDF 结构操作

**我们的方案**：
- 使用 Web Crypto API 实现真正的内容加密
- 加密整个 PDF 文件，而不是 PDF 内部对象
- 提供更强的加密强度（AES-256-GCM）

---

## 🔧 技术实现

### 核心代码结构

```typescript
// 1. 加密 PDF
const lockPDF = async (file: File) => {
  // 读取原始 PDF
  const originalBytes = await originalPdfDoc.save()
  
  // 生成加密密钥
  const salt = crypto.getRandomValues(new Uint8Array(16))
  const key = await CryptoUtils.deriveKeyFromPassword(password, salt)
  
  // 加密内容
  const { encrypted, iv } = await CryptoUtils.encrypt(originalBytes, key)
  
  // 创建保护页面
  const protectedPdf = await PDFDocument.create()
  // ... 添加信息页面
  
  // 嵌入加密数据
  const finalBytes = [protectedPdf, separator, encrypted, metadata]
  
  // 保存
  saveAs(blob, 'xxx-locked.pdf')
}

// 2. 解密 PDF
const unlockPDF = async (file: File) => {
  // 提取加密信息
  const encryptionInfo = extractEncryptionInfo(fileBytes)
  
  // 派生密钥
  const key = await CryptoUtils.deriveKeyFromPassword(password, salt)
  
  // 解密内容
  const decryptedBytes = await CryptoUtils.decrypt(encrypted, key, iv)
  
  // 恢复 PDF
  const decryptedPdf = await PDFDocument.load(decryptedBytes)
  
  // 保存
  saveAs(blob, 'xxx-unlocked.pdf')
}
```

### 加密流程图

```
┌─────────────┐
│  原始 PDF   │
└──────┬──────┘
       │
       ▼
┌─────────────┐     ┌──────────┐
│ 用户输入密码 │────▶│ PBKDF2   │
└─────────────┘     │ 100K次   │
                    └────┬─────┘
                         │
                         ▼
                    ┌──────────┐
                    │ AES Key  │
                    └────┬─────┘
                         │
       ┌─────────────────┴─────────────────┐
       ▼                                   ▼
┌─────────────┐                    ┌──────────────┐
│ AES-256-GCM │                    │  随机 IV     │
│   加密      │                    │  (12 bytes)  │
└──────┬──────┘                    └──────────────┘
       │
       ▼
┌─────────────┐
│  加密数据   │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 创建保护PDF │
│ + 嵌入数据  │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 受保护的PDF │
└─────────────┘
```

---

## 📋 使用示例

### 示例 1：标准加密（日常文档）

```
1. 打开 PDF 工具
2. 选择"PDF 加密/解密"
3. 点击"加密 PDF（Lock）"
4. 选择"标准加密"模式
5. 设置密码：MyPassword123
6. 配置权限（如取消"允许打印"）
7. 上传文件：report.pdf
8. 下载：report-protected.pdf
9. 可以用任何 PDF 阅读器打开
```

### 示例 2：强加密（敏感文档）

```
1. 打开 PDF 工具
2. 选择"PDF 加密/解密"
3. 点击"加密 PDF（Lock）"
4. 选择"强加密"模式
5. 设置密码：MySecurePassword123
6. 取消勾选"允许打印"
7. 上传文件：contract.pdf
8. 下载：contract-locked.pdf
9. 需要本工具解密才能查看
```

### 示例 3：解密文档

```
1. 打开 PDF 工具
2. 选择"PDF 加密/解密"
3. 点击"解密 PDF（Unlock）"
4. 输入密码：MySecurePassword123
5. 上传文件：contract-locked.pdf
6. 下载：contract-unlocked.pdf
```

---

## 🐛 故障排除

### 问题 1：加密失败

**可能原因**：
- 密码未设置
- PDF 文件损坏
- 浏览器不支持 Web Crypto API

**解决方案**：
- 确保设置了打开密码
- 尝试使用其他 PDF 文件
- 更新浏览器到最新版本

### 问题 2：解密失败（密码错误）

**可能原因**：
- 密码输入错误
- 大小写错误
- 使用了错误的 PDF 文件

**解决方案**：
- 仔细检查密码
- 确认是否为加密时使用的密码
- 确认文件是使用本工具加密的

### 问题 3：解密后 PDF 无法打开

**可能原因**：
- 原始 PDF 已损坏
- 加密过程中出现错误

**解决方案**：
- 重新加密原始文件
- 检查原始文件是否完整

---

## 🚀 未来改进

### 计划中的功能

1. **批量加密/解密**
   - 支持一次处理多个 PDF 文件

2. **密钥文件支持**
   - 除了密码，还可以使用密钥文件

3. **加密强度选择**
   - AES-128 / AES-256
   - 自定义 PBKDF2 迭代次数

4. **权限强制执行**
   - 在解密后的 PDF 中强制执行权限限制

5. **密码强度检测**
   - 实时检测密码强度
   - 提供密码建议

---

## 📞 技术支持

如有问题或建议，请联系开发团队。

---

**版本**：1.0.0  
**最后更新**：2025-12-29  
**作者**：CommonTools Team

