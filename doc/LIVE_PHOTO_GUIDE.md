# 📸 Live Photo 转换工具使用指南

## 功能概述

将 iPhone 实况照片（Live Photo）转换为普通格式，完美分享到安卓/微信/PC等平台。

### 核心功能

1. **静态图片提取** - 将 HEIC 转换为 JPG
2. **GIF 动图生成** - 将 MOV 转换为 GIF（适合微信分享）
3. **MP4 视频转换** - 将 MOV 转换为兼容的 MP4（保留原画质）
4. **智能帧去重** - 自动删除重复帧，减小文件大小

---

## 技术实现

### 核心技术栈

- **heic2any**: HEIC 图片格式转换
- **@ffmpeg/ffmpeg**: 视频处理（WebAssembly）
- **FFmpeg Filter**: 调色板优化、帧去重、缩放等

### 处理流程

#### 1. 静态图片模式（HEIC → JPG）

```
HEIC 文件 → heic2any 转换 → JPG 输出
```

**特点**：
- 质量：95%（高质量）
- 速度：快速（纯 JS 处理）
- 兼容性：完美（所有平台支持 JPG）

#### 2. GIF 动图模式（MOV → GIF）

```
MOV 文件 → FFmpeg 提取帧 → 调色板优化 → GIF 输出
```

**处理步骤**：
1. 按指定帧率（5-30fps）提取视频帧
2. 使用 Lanczos 算法缩放到目标宽度
3. 生成优化的调色板（最多256色）
4. 使用 Bayer 抖动算法减少色带
5. 启用差分模式优化文件大小

**FFmpeg 命令**：
```bash
# 提取帧
-i input.mov -vf fps=10,scale=480:-1:flags=lanczos frame%04d.png

# 生成 GIF
-i input.mov 
-filter_complex "fps=10,scale=480:-1:flags=lanczos,split[s0][s1];[s0]palettegen=max_colors=256:stats_mode=diff[p];[s1][p]paletteuse=dither=bayer:bayer_scale=10:diff_mode=rectangle" 
-loop 0 
output.gif
```

#### 3. MP4 视频模式（MOV → MP4）

```
MOV 文件 → FFmpeg 重编码 → MP4 输出
```

**编码参数**：
- 视频编码：H.264 (libx264)
- CRF 质量：18-28（默认 23）
- 预设：medium（平衡速度和质量）
- 像素格式：yuv420p（最佳兼容性）
- FastStart：启用（支持流式播放）

**帧去重**：
- 过滤器：mpdecimate
- 阈值：动态调整（1-20%）
- 效果：可减少 30-50% 文件大小

**FFmpeg 命令**：
```bash
-i input.mov 
-c:v libx264 
-crf 23 
-preset medium 
-movflags +faststart 
-pix_fmt yuv420p 
-vf "mpdecimate=hi=64*5:lo=64*5:frac=0.33" 
output.mp4
```

---

## 使用方法

### 1. 获取 Live Photo 文件

#### 方法 A：通过 AirDrop 导出

1. 在 iPhone 照片应用中选择实况照片
2. 点击分享按钮
3. 选择 AirDrop 发送到 Mac
4. 会收到两个文件：
   - `IMG_1234.HEIC`（静态图）
   - `IMG_1234.MOV`（短视频）

#### 方法 B：通过文件应用导出

1. 在 iPhone 上使用"文件"应用
2. 找到照片文件夹
3. 选择实况照片
4. 导出为文件
5. 上传到电脑

### 2. 选择转换模式

#### 静态图片（仅需 HEIC）

- **适用场景**：只需要静态图片，不需要动效
- **输出格式**：JPG
- **优点**：文件小、兼容性好
- **上传要求**：仅上传 HEIC 文件

#### GIF 动图（仅需 MOV）

- **适用场景**：微信/QQ 分享，需要动效
- **输出格式**：GIF
- **优点**：兼容性好、自动播放
- **缺点**：文件较大、无音频
- **上传要求**：仅上传 MOV 文件

**推荐设置**：
- 帧率：10fps（流畅度适中）
- 宽度：480px（文件大小适中）
- 质量：10（平衡质量和大小）

#### MP4 视频（仅需 MOV）

- **适用场景**：保存高质量视频、需要音频
- **输出格式**：MP4
- **优点**：画质好、文件小、支持音频
- **缺点**：部分老旧设备可能不支持
- **上传要求**：仅上传 MOV 文件

**推荐设置**：
- 质量（CRF）：23（标准质量）
- 帧去重：启用（减小文件大小）
- 去重阈值：5%（适中）

### 3. 调整高级设置

#### GIF 设置

- **GIF 质量（1-20）**
  - 数值越低：质量越高，颜色更丰富，文件越大
  - 数值越高：质量越低，颜色简化，文件越小
  - 推荐：10（平衡）

- **帧率（5-30fps）**
  - 越高：越流畅，文件越大
  - 越低：卡顿，文件越小
  - 推荐：10fps（微信分享）/ 15fps（高质量）

- **宽度（240-1080px）**
  - 越大：越清晰，文件越大
  - 越小：模糊，文件越小
  - 推荐：480px（手机屏幕）/ 720px（平板/PC）

#### MP4 设置

- **MP4 质量（CRF: 18-28）**
  - 18：近无损质量，文件大
  - 23：标准质量（推荐）
  - 28：低质量，文件小
  - 推荐：23

- **帧去重**
  - 启用：自动删除重复帧，显著减小文件大小
  - 适用场景：静态场景较多的实况照片
  - 效果：通常可减小 30-50% 文件大小

- **去重阈值（1-20%）**
  - 越低：越严格，保留更多细节，文件稍大
  - 越高：越激进，删除更多帧，文件更小
  - 推荐：5%

---

## 性能优化

### 首次加载

- FFmpeg WebAssembly 首次加载约 30MB
- 加载后会缓存到浏览器，后续使用无需重新下载
- 推荐网络环境：4G 或 Wi-Fi

### 处理速度

| 输入 | 模式 | 预计时间 |
|------|------|----------|
| 3秒 MOV (2MB) | GIF (480p, 10fps) | 10-15秒 |
| 3秒 MOV (2MB) | MP4 (720p, CRF23) | 5-10秒 |
| HEIC (3MB) | JPG | 1-2秒 |

### 文件大小对比

| 原始 MOV | GIF (480p, 10fps) | MP4 (720p, CRF23) | MP4 (帧去重) |
|----------|-------------------|-------------------|-------------|
| 2MB | 1.5-3MB | 800KB-1.5MB | 500KB-1MB |

---

## 常见问题

### Q1: 为什么需要同时上传 HEIC 和 MOV？

**A:** Live Photo 包含两个独立文件：
- HEIC：静态高清图片
- MOV：3秒短视频

根据需求选择：
- 仅需静态图：上传 HEIC
- 仅需动效：上传 MOV
- 完整体验：上传两个文件（当前版本各模式独立）

### Q2: GIF 和 MP4 哪个更好？

**A:** 取决于使用场景：

**GIF 优势**：
- ✅ 兼容性好（所有平台支持）
- ✅ 自动循环播放
- ✅ 适合微信/QQ 分享
- ❌ 文件大、无音频、颜色有限

**MP4 优势**：
- ✅ 文件小、画质好
- ✅ 支持音频
- ✅ 流式播放
- ❌ 部分老旧设备不支持

**推荐**：
- 微信/QQ 分享：GIF
- 保存原画质：MP4
- 社交媒体：MP4

### Q3: 如何减小 GIF 文件大小？

**A:** 调整以下参数：
1. 降低帧率（10fps → 8fps）
2. 降低宽度（480px → 360px）
3. 提高质量数值（10 → 15）
4. 缩短视频长度（仅转换前2秒）

### Q4: 为什么首次使用很慢？

**A:** 首次需要下载 FFmpeg WebAssembly（约30MB）。
- 下载后会永久缓存到浏览器
- 后续使用无需重新下载
- 推荐在 Wi-Fi 下首次使用

### Q5: 转换失败怎么办？

**A:** 检查以下几点：
1. 确认文件格式正确（HEIC/MOV）
2. 确认文件未损坏
3. 尝试刷新页面重新加载
4. 尝试降低质量设置
5. 检查浏览器控制台错误信息

---

## 隐私保护

- ✅ 所有转换在浏览器本地完成
- ✅ 文件不会上传到服务器
- ✅ 无需注册，无需登录
- ✅ 转换完成后可立即关闭页面
- ✅ 不保留任何用户数据

---

## 浏览器兼容性

### 推荐浏览器

- ✅ Chrome 90+
- ✅ Edge 90+
- ✅ Firefox 88+
- ✅ Safari 15+

### 最低要求

- WebAssembly 支持
- 足够的内存（建议 4GB+）
- 现代浏览器（2020年后发布）

---

## 技术细节

### FFmpeg Filter 说明

#### 调色板生成（palettegen）

```
palettegen=max_colors=256:stats_mode=diff
```
- `max_colors=256`: GIF 最多256色
- `stats_mode=diff`: 使用差分统计（优化动画）

#### 调色板应用（paletteuse）

```
paletteuse=dither=bayer:bayer_scale=10:diff_mode=rectangle
```
- `dither=bayer`: 使用 Bayer 抖动算法
- `bayer_scale`: 抖动强度（1-20）
- `diff_mode=rectangle`: 仅重绘变化区域

#### 帧去重（mpdecimate）

```
mpdecimate=hi=64*5:lo=64*5:frac=0.33
```
- `hi`: 高阈值（像素差异）
- `lo`: 低阈值（像素差异）
- `frac`: 最小变化比例（33%）

---

## 性能建议

### 推荐配置

**微信/QQ 分享**：
- 模式：GIF
- 帧率：10fps
- 宽度：480px
- 质量：10

**高质量保存**：
- 模式：MP4
- 质量：23
- 帧去重：启用
- 阈值：5%

**快速转换**：
- 模式：静态图片
- 仅上传 HEIC

---

## 故障排查

### 问题1：FFmpeg 加载失败

**症状**：显示"视频处理引擎加载失败"

**解决**：
1. 检查网络连接
2. 清除浏览器缓存
3. 刷新页面重试
4. 更换浏览器（推荐 Chrome）

### 问题2：转换速度很慢

**原因**：
- 设备性能较低
- GIF 分辨率过高
- 帧率过高

**解决**：
1. 降低 GIF 宽度（480px → 360px）
2. 降低帧率（10fps → 8fps）
3. 使用 MP4 模式代替 GIF

### 问题3：GIF 文件过大

**解决**：
1. 降低宽度（480px → 360px）
2. 降低帧率（10fps → 8fps）
3. 提高质量数值（10 → 15）
4. 使用 MP4 模式（文件更小）

### 问题4：转换后颜色失真

**GIF 模式**：
- 正常现象（GIF 仅支持256色）
- 降低质量数值可改善（10 → 5）

**MP4 模式**：
- 检查质量设置（CRF 不要超过25）
- 确保原始 MOV 文件质量良好

---

## 最佳实践

### 1. 批量转换

- 建议单个文件转换完成后再处理下一个
- 避免同时处理多个大文件（占用内存）

### 2. 文件命名

- 转换后的文件自动命名为 `live-photo-{timestamp}.{ext}`
- 可在下载后手动重命名

### 3. 质量与大小平衡

**追求质量**：
- GIF：质量 1-5，帧率 15fps，宽度 720px
- MP4：CRF 18-20

**追求文件小**：
- GIF：质量 15-20，帧率 8fps，宽度 360px
- MP4：CRF 25-28，启用帧去重

**平衡推荐**：
- GIF：质量 10，帧率 10fps，宽度 480px
- MP4：CRF 23，启用帧去重（阈值5%）

---

## 限制说明

1. **文件大小限制**：
   - 推荐 MOV 文件 < 50MB
   - 超大文件可能导致浏览器卡顿

2. **处理时间**：
   - GIF 模式：可能需要 10-30秒
   - MP4 模式：可能需要 5-15秒
   - 取决于文件大小和设备性能

3. **浏览器内存**：
   - 推荐可用内存 > 2GB
   - 处理大文件时关闭其他标签页

---

## 更新日志

### v1.0.0 (2026-01-15)

- ✅ 支持 HEIC 转 JPG
- ✅ 支持 MOV 转 GIF
- ✅ 支持 MOV 转 MP4
- ✅ 智能帧去重
- ✅ 调色板优化
- ✅ 进度显示
- ✅ 本地处理
- ✅ 隐私保护
