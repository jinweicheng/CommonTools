# 🎬 视频压缩功能 - 完整实现文档

## ✅ 功能概述

完整实现了基于 **FFmpeg.wasm** 的专业视频压缩功能，支持批量处理、多种编码格式、三种压缩模式，100% 本地处理，保护用户隐私。

---

## 🎯 核心功能特性

### 1. 批量处理与限制
- ✅ **最多 5 个视频**：防止浏览器内存溢出
- ✅ **单文件 ≤ 500MB**：确保处理稳定性
- ✅ **超限提示**：友好的错误提示弹窗
- ✅ **串行处理**：一次处理一个视频，避免炸内存
- ✅ **任务队列**：自动管理待处理任务

### 2. 支持的视频格式
- **输入格式**：MP4, MOV, AVI, WebM, M4V
- **输出格式**：MP4 (H.264/VP9 编码)
- **格式检测**：MIME type + 文件扩展名双重检测

### 3. 三种压缩模式

#### 模式 1：CRF（画质优先）⭐推荐
```
- 参数范围：18-28
- 推荐值：23（默认）
- 特点：固定质量，文件大小自适应
- 适用场景：个人存储、视频归档
```

#### 模式 2：目标码率（流媒体场景）
```
- 参数范围：500-10000 kbps
- 推荐值：2000-4000 kbps
- 特点：固定码率，质量自适应
- 适用场景：流媒体播放、网络分享
```

#### 模式 3：目标文件大小（办公最常用）⭐
```
- 参数范围：1-500 MB
- 推荐值：根据需求设定（如 50MB）
- 特点：自动计算码率以达到目标大小
- 适用场景：邮件附件、文档嵌入
```

### 4. 编码器选择

#### H.264 (libx264) ⭐主力编码器
```
✅ 优势：
- 兼容性极佳（所有设备/浏览器）
- 硬件解码支持广泛
- 压缩效率高
- 行业标准

🎯 适用场景：
- 通用视频压缩
- 跨平台分享
- 在线播放
```

#### VP9 (libvpx-vp9) 
```
✅ 优势：
- 压缩效率更高（同质量下文件更小）
- WebM 容器原生支持
- 开源免费

⚠️ 限制：
- 编码速度较慢
- 部分老设备不支持

🎯 适用场景：
- 网页播放
- 文件大小敏感场景
```

### 5. 高级设置

#### 分辨率调整
```
- 保持原始（默认）
- 1080p (1920x1080)
- 720p  (1280x720)
- 480p  (854x480)
```

#### 帧率限制
```
- 保持原始（默认）
- 60 FPS
- 30 FPS
- 24 FPS（电影标准）
```

### 6. 任务控制
- ✅ **开始/暂停/继续**：灵活控制处理流程
- ✅ **取消处理**：立即停止所有任务
- ✅ **单任务失败不中断**：失败任务自动跳过，继续处理下一个
- ✅ **实时进度**：显示当前任务处理进度（0-100%）

### 7. 用户体验优化

#### 视频预览
```
- 原视频预览：上传后即可查看
- 压缩后预览：处理完成后对比效果
- 视频信息显示：分辨率、时长、大小
```

#### 统计信息
```
- 原始总大小
- 压缩后总大小
- 节省空间（MB + 百分比）
- 完成文件数 / 总文件数
```

#### 交互增强
```
- 拖拽上传支持
- 拖拽排序任务
- 批量选择任务
- 批量应用设置
- 完成音效提示
```

---

## 🔧 技术实现细节

### 1. FFmpeg.wasm 集成

#### 加载策略
```typescript
// CDN 加载（UNPKG）
const baseURL = 'https://unpkg.com/@ffmpeg/core@0.12.6/dist/umd'
await ffmpeg.load({
  coreURL: await toBlobURL(`${baseURL}/ffmpeg-core.js`, 'text/javascript'),
  wasmURL: await toBlobURL(`${baseURL}/ffmpeg-core.wasm`, 'application/wasm')
})
```

#### 加载状态管理
```
- ffmpegLoading: 加载中
- ffmpegLoaded: 加载完成
- 加载失败提示用户刷新
```

### 2. FFmpeg 命令构建

#### CRF 模式示例
```bash
ffmpeg -i input.mp4 -c:v libx264 -crf 23 -c:a aac -b:a 128k output.mp4
```

#### 目标码率模式示例
```bash
ffmpeg -i input.mp4 -c:v libx264 -b:v 2000k -c:a aac -b:a 128k output.mp4
```

#### 目标大小模式示例
```bash
# 自动计算码率 = (目标大小 * 8 * 1024) / 视频时长
ffmpeg -i input.mp4 -c:v libx264 -b:v 计算值k -c:a aac -b:a 128k output.mp4
```

#### 分辨率缩放示例
```bash
ffmpeg -i input.mp4 -c:v libx264 -crf 23 -vf "scale=1280:-2" -c:a aac output.mp4
# -2 表示保持宽高比，自动计算高度（偶数）
```

#### 帧率限制示例
```bash
ffmpeg -i input.mp4 -c:v libx264 -crf 23 -r 30 -c:a aac output.mp4
```

### 3. 任务队列管理

#### 串行处理流程
```
1. 用户点击"开始处理"
2. 加载 FFmpeg（如未加载）
3. 获取第一个 pending 任务
4. 处理任务（更新进度）
5. 完成后处理下一个
6. 直到所有任务完成
```

#### 状态机
```
pending    → 等待处理
processing → 正在处理
paused     → 已暂停
completed  → 已完成
failed     → 处理失败
cancelled  → 已取消
```

### 4. 进度监听

```typescript
ffmpeg.on('progress', ({ progress }) => {
  const progressValue = Math.round(progress * 100) // 0-100
  // 更新任务进度
})
```

### 5. 内存管理

#### 文件系统清理
```typescript
// 处理完成后清理
await ffmpeg.deleteFile('input.mp4')
await ffmpeg.deleteFile('output.mp4')
```

#### 对象 URL 清理
```typescript
useEffect(() => {
  return () => {
    tasks.forEach(task => {
      if (task.originalPreview) URL.revokeObjectURL(task.originalPreview)
      if (task.compressedPreview) URL.revokeObjectURL(task.compressedPreview)
    })
  }
}, [])
```

---

## 📊 性能优化

### 1. 串行处理
```
优势：
- 内存占用可控
- 不会崩溃浏览器
- 进度清晰可见

限制：
- 处理速度较慢（一次一个）
- 无法利用多核
```

### 2. 压缩参数推荐

#### 快速压缩（质量优先）
```
模式：CRF
CRF：23
编码器：H.264
分辨率：原始
帧率：原始
```

#### 平衡压缩（推荐）
```
模式：CRF
CRF：25
编码器：H.264
分辨率：1080p
帧率：30 FPS
```

#### 极限压缩（文件大小优先）
```
模式：目标大小
目标：原大小的 30-50%
编码器：VP9
分辨率：720p
帧率：24 FPS
```

### 3. 预计处理时间

```
参考数据（H.264, CRF 23）：
- 1080p 60fps 1分钟视频：约 2-5 分钟
- 720p 30fps 1分钟视频：约 1-2 分钟
- 480p 30fps 1分钟视频：约 30-60 秒

影响因素：
- 视频分辨率
- 视频帧率
- 编码器（VP9 比 H.264 慢 2-3 倍）
- CRF 值（越小越慢）
- 设备性能
```

---

## ⚠️ 注意事项与限制

### 1. 浏览器兼容性
```
✅ 支持：
- Chrome 89+
- Edge 89+
- Firefox 90+
- Safari 15+

❌ 不支持：
- IE 全系列
- 旧版移动浏览器
```

### 2. FFmpeg.wasm 限制
```
⚠️ 限制：
- 编码速度慢（无硬件加速）
- 内存占用大（建议设备内存 ≥ 4GB）
- 不支持某些编码器（如 x265）
- 不支持 GPU 加速
```

### 3. 文件大小限制
```
⚠️ 建议：
- 单文件 ≤ 500MB（硬限制）
- 总大小 ≤ 2GB（推荐）
- 超大文件建议使用桌面软件
```

### 4. 内存占用
```
预计内存占用：
- 500MB 视频：约 2-3GB 内存
- 200MB 视频：约 1-1.5GB 内存
- 100MB 视频：约 500MB-1GB 内存

建议：
- 设备内存 ≥ 8GB
- 关闭其他占内存的标签页
- 一次处理 1-2 个视频
```

---

## 🎨 UI/UX 设计

### 1. 设计风格
```
- 科技感：渐变色、发光效果
- 安全感：暗色主题、蓝绿色调
- 专业感：清晰的层次、统一的间距
```

### 2. 交互反馈
```
- 悬停效果：所有可点击元素
- 过渡动画：200-300ms
- 进度条：平滑过渡
- 完成音效：任务全部完成时播放
```

### 3. 响应式设计
```
- 桌面端：多列布局
- 平板：两列布局
- 移动端：单列布局
- 最小支持宽度：320px
```

---

## 🚀 使用流程

### 基础流程
```
1. 上传视频（拖拽或点击）
2. 选择压缩模式
3. 调整参数（可选）
4. 点击"开始处理"
5. 等待处理完成
6. 预览效果
7. 下载压缩后的视频
```

### 批量处理流程
```
1. 上传多个视频（最多 5 个）
2. 批量应用压缩设置
3. 或为每个视频单独设置
4. 开始处理（自动串行）
5. 暂停/继续/取消（随时控制）
6. 下载全部（自动打包 ZIP）
```

---

## 📦 文件结构

```
src/
├── components/
│   ├── VideoCompression.tsx     # 主组件（1100+ 行）
│   └── VideoCompression.css     # 样式文件
├── pages/
│   └── VideoCompressionPage.tsx # 页面组件
└── doc/
    └── VIDEO_COMPRESSION_GUIDE.md # 本文档
```

---

## 🔍 常见问题

### Q1: 处理速度很慢怎么办？
**A**: 
- 降低 CRF 值（提高质量会更慢）
- 降低分辨率（720p/480p）
- 降低帧率（24/30 FPS）
- 使用 H.264 而非 VP9
- 处理较小的文件

### Q2: 浏览器卡死/崩溃？
**A**:
- 减少同时处理的视频数量
- 处理较小的文件
- 关闭其他占内存的标签页
- 重启浏览器
- 使用桌面版 FFmpeg（大文件）

### Q3: 压缩后文件反而更大？
**A**:
- 原视频可能已经高度压缩
- CRF 值太低（质量太高）
- 分辨率/帧率提升
- 建议使用"目标大小"模式

### Q4: 视频质量下降明显？
**A**:
- 降低 CRF 值（如 23 → 20）
- 提高目标码率
- 不要过度降低分辨率
- 原视频质量可能就不高

### Q5: 支持哪些视频编解码器？
**A**:
- 输入：大部分常见格式（FFmpeg 支持的）
- 输出：H.264 (libx264), VP9 (libvpx-vp9)
- 音频：AAC 128kbps

---

## 🎯 未来优化方向

### 短期优化
- [ ] 添加预设模板（快速/平衡/高质量）
- [ ] 显示预计处理时间
- [ ] 添加进度时间估算
- [ ] 支持视频裁剪

### 中期优化
- [ ] 并发处理（2 个视频同时）
- [ ] 智能压缩（自动选择最佳参数）
- [ ] 批量转码（格式转换）
- [ ] 视频合并/分割

### 长期优化
- [ ] WebCodecs API（硬件加速）
- [ ] WASM SIMD 优化
- [ ] WebGPU 加速
- [ ] 云端处理选项（超大文件）

---

## 📚 参考资源

### FFmpeg 相关
- [FFmpeg Official](https://ffmpeg.org/)
- [FFmpeg.wasm Documentation](https://ffmpegwasm.netlify.app/)
- [H.264 Encoding Guide](https://trac.ffmpeg.org/wiki/Encode/H.264)
- [VP9 Encoding Guide](https://trac.ffmpeg.org/wiki/Encode/VP9)

### Web 技术
- [File API](https://developer.mozilla.org/en-US/docs/Web/API/File)
- [Blob API](https://developer.mozilla.org/en-US/docs/Web/API/Blob)
- [URL.createObjectURL](https://developer.mozilla.org/en-US/docs/Web/API/URL/createObjectURL)

---

## ✅ 功能清单

### 基础功能
- [x] 批量上传（最多 5 个，≤500MB）
- [x] 格式支持（MP4/MOV/AVI/WebM/M4V）
- [x] 三种压缩模式（CRF/码率/大小）
- [x] 两种编码器（H.264/VP9）
- [x] 串行处理队列
- [x] 暂停/继续/取消
- [x] 实时进度显示
- [x] 失败不中断

### 高级功能
- [x] 分辨率调整
- [x] 帧率限制
- [x] 视频预览（原始/压缩）
- [x] 统计信息展示
- [x] 批量设置应用
- [x] 拖拽排序
- [x] 完成音效

### UI/UX
- [x] 科技安全风格
- [x] 响应式设计
- [x] 加载状态提示
- [x] 错误提示优化
- [x] 拖拽上传
- [x] 中英文支持

---

**最后更新**: 2026-01-22  
**版本**: 1.0  
**状态**: ✅ 生产就绪
