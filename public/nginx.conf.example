# ========================================
# Nginx 服务器配置示例 - SPA 路由支持
# ========================================
# 将此配置添加到你的 Nginx 站点配置文件中
# 路径：/etc/nginx/sites-available/your-site 或直接在 nginx.conf 中

server {
    listen 80;
    server_name commontools.top;
    
    # 如果需要 HTTPS，取消下面的注释并配置 SSL
    # listen 443 ssl http2;
    # ssl_certificate /path/to/ssl/cert.pem;
    # ssl_certificate_key /path/to/ssl/key.pem;
    
    # 网站根目录（指向构建后的 dist 目录）
    root /path/to/your/dist;
    index index.html;
    
    # ========================================
    # SPA 路由支持 - 解决刷新 404 问题
    # 支持两种URL格式：
    # - /tools/conversion (带 /tools/ 前缀)
    # - /conversion (不带 /tools/ 前缀)
    # ========================================
    
    # 处理带 /tools/ 前缀的路径
    location /tools/ {
        alias /path/to/your/dist/;
        try_files $uri $uri/ /tools/index.html;
    }
    
    # 处理不带 /tools/ 前缀的路径（重定向到 /tools/ 或直接服务 index.html）
    location ~ ^/(conversion|watermark|signature|compression|heic-to-jpg|live-photo|password-manager|support|support-policy|privacy-policy|terms-of-service|login)/?$ {
        # 301 永久重定向到带 /tools/ 前缀的URL（推荐，SEO友好）
        rewrite ^/(.*)$ /tools/$1 permanent;
        
        # 或者直接服务 index.html（如果不想重定向）
        # try_files /tools/index.html =404;
    }
    
    # 处理根路径
    location = / {
        return 301 /tools/;
    }
    
    # 确保所有其他不存在的路径也回退到 index.html
    location / {
        try_files $uri $uri/ /tools/index.html;
    }
    
    # ========================================
    # PDF.js Worker MIME 类型配置
    # ========================================
    location ~ \.mjs$ {
        add_header Content-Type application/javascript;
        add_header Access-Control-Allow-Origin *;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    # ========================================
    # 静态资源缓存
    # ========================================
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    # ========================================
    # HTML 文件不缓存
    # ========================================
    location ~* \.html$ {
        expires -1;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
    }
    
    # ========================================
    # 安全头设置
    # ========================================
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    
    # ========================================
    # Gzip 压缩
    # ========================================
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/javascript application/xml+rss application/json;
}
